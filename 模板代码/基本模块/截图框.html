/*样式*/
/*裁剪图片框的样式*/
.hide {display: none;}
.show {display: block;}
#clipArea {margin: 0 auto; width:100%;height:100%;background:#f2f2f2;}
#clipBtn{margin-top: 5px;background-color: rgb(221, 39, 39);color: #fff;padding: 8px 20px;border-radius: 5px;width: 2.5rem; position:fixed; right:0; bottom:0; z-index:999999999}
#clipBtn1{margin-top: 5px;background-color: rgb(221, 39, 39);color: #fff;padding: 8px 20px;border-radius: 5px;width: 2.7rem; position:fixed; left:0; bottom:0; z-index:999999999}
.caiBox{ position:fixed; left:0; top:0; z-index:99999999; width:100%; height:100%; display:none}
/*裁剪图片框的样式*/





/*html*/
<!--图片裁剪框-->
<div class="caiBox">
	<h2 style="width:100%; text-align:center; position:fixed; top:0; left:0; line-height:0.6rem; font-size:0.4rem;color:#4eaf7a; z-index:999999999">双指旋转和双指缩放</h2>
	<button id="clipBtn">确定裁剪</button>
	<button id="clipBtn1" onClick="Close()">取消</button>
	<div id="clipArea"></div>
	<canvas id="myCanvas" style=" display:none"></canvas>
</div>
<!--图片裁剪框-->


/*插件*/
<!--图片裁剪插件-->
<script type="text/javascript" src="http://qhb.lelego.net.cn/upload/tpl_file/public/jquery.photoClip.js"></script>
<script type="text/javascript" src="http://qhb.lelego.net.cn/upload/tpl_file/public/hammer.js"></script>
<script type="text/javascript" src="http://qhb.lelego.net.cn/upload/tpl_file/public/iscroll-zoom.js"></script>
<script type="text/javascript" src="http://qhb.lelego.net.cn/upload/tpl_file/public/sonic.js"></script>



/*调用*/
<img id="edimg5" onClick="clipPhoto('#edimg5_img',$(this),'100','130','4')" class="editBorder" src="<{$template_path}>/pic_04@2x.png" />
<input id="edimg5_img" type="file" accept="image/*" style="display: none;" />


/*js*/
	//分享封面图片
	var tal_shareBgi = new Array();
	var imgArr = new Array();


	//自定义图片（裁剪）函数
	//file_id上传图片的（input）id，view_id:截图完成显示的id(img);
	//view_width,view_height:截取区域宽高，imgIndex:图片的下标
	function clipPhoto(file_id,view_id,view_width,view_height,imgIndex){
		var v_id;
		//等于-1就是分享图片
		if(imgIndex != -1){
			v_id = '#'+$(view_id)[0].id;
			$(view_id).next().click();
		}else{
			v_id = view_id;
		}
		$("#clipArea").photoClip({
			width: view_width,
			height: view_height,
			file: file_id,
			view: v_id,//传进来的$(this),所以要拿id
			ok: "#clipBtn", //确定裁剪的按钮
			loadStart: function () {
				//开始加载回调函数，this指向 fileReader 对象
				$(".caiBox").show();
			},
			loadComplete: function () {
				//加载完成的回调函数。this指向图片对象
			},
			clipFinish: function (dataURL) {
				//裁剪完成的回调函数。this指向图片对象
				$(v_id).attr('src', dataURL);
				if(imgIndex != '-1'){
					//给自定义图片数组赋值（不包含分享图片）
					imgArr[imgIndex] = dataURL;
				}else{
					tal_shareBgi.push(dataURL);
				}
				//隐藏截图页面
				$(".caiBox").hide();
				//放大缩小后从新渲染截图背景
				render(dataURL);
				//清空上一张图片的缓存
				$(".photo-clip-mask").remove();
				$(".photo-clip-view").remove();
			}
		});
	};
	//关闭裁剪函数
	function Close(){
		$('.caiBox').hide();
	} 
	// 渲染 Image 缩放尺寸  
	function render(src){  
		 var MAX_HEIGHT = 256;  //Image 缩放尺寸 
		// 创建一个 Image 对象  
		var image = new Image();  
		
		// 绑定 load 事件处理器，加载完成后执行  
		image.onload = function(){  
			// 获取 canvas DOM 对象  
			var canvas = document.getElementById("myCanvas"); 
			// 如果高度超标  
			if(image.height > MAX_HEIGHT) {  
				// 宽度等比例缩放 *=  
				image.width *= MAX_HEIGHT / image.height;  
				image.height = MAX_HEIGHT;  
			}  
			// 获取 canvas的 2d 环境对象,  
			// 可以理解Context是管理员，canvas是房子  
			var ctx = canvas.getContext("2d");  
			// canvas清屏  
			ctx.clearRect(0, 0, canvas.width, canvas.height); 
			canvas.width = image.width;        // 重置canvas宽高  
			canvas.height = image.height;  
			// 将图像绘制到canvas上  
			/*ctx.drawImage(image, 0, 0, image.width, image.height); */ 
			// !!! 注意，image 没有加入到 dom之中  
			
		 var dataurl = canvas.toDataURL("image/jpeg");  
		 var imagedata =  encodeURIComponent(dataurl); 
		};  
		// 设置src属性，浏览器会自动加载。  
		// 记住必须先绑定render()事件，才能设置src属性，否则会出同步问题。  
		image.src = src;	
	};
















